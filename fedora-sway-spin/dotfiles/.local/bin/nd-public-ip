#!/usr/bin/env bash
set -euo pipefail

#
# nd-public-ip - Monitor de cambios de IP pública
#
# Uso:
#   nd-public-ip          - Chequea IP y alerta si cambió
#   nd-public-ip update   - Acepta la IP actual y quita la alerta
#   nd-public-ip show     - Muestra la IP actual sin comparar
#

CACHE_DIR="${HOME}/.cache/nd-public-ip"
LAST_IP_FILE="${CACHE_DIR}/last_ip"
ALERT_FILE="${CACHE_DIR}/alert"
NEW_IP_FILE="${CACHE_DIR}/new_ip"

mkdir -p "$CACHE_DIR"

get_public_ip() {
    curl -s --max-time 10 ifconfig.me 2>/dev/null
}

show_alert() {
    if [[ -f "$ALERT_FILE" ]]; then
        local old_ip new_ip
        old_ip=$(cat "$LAST_IP_FILE" 2>/dev/null || echo "desconocida")
        new_ip=$(cat "$NEW_IP_FILE" 2>/dev/null || echo "desconocida")

        echo ""
        echo -e "\033[1;5;31m╔══════════════════════════════════════════════════════════════╗\033[0m"
        echo -e "\033[1;5;31m║                    ⚠️  IP PUBLICA CAMBIO  ⚠️                   ║\033[0m"
        echo -e "\033[1;5;31m╠══════════════════════════════════════════════════════════════╣\033[0m"
        printf "\033[1;31m║  Anterior: \033[1;33m%-48s\033[1;31m ║\033[0m\n" "$old_ip"
        printf "\033[1;31m║  Nueva:    \033[1;32m%-48s\033[1;31m ║\033[0m\n" "$new_ip"
        echo -e "\033[1;31m╠══════════════════════════════════════════════════════════════╣\033[0m"
        echo -e "\033[1;31m║  Ejecuta: \033[1;36mnd-public-ip update\033[1;31m  para aceptar              ║\033[0m"
        echo -e "\033[1;5;31m╚══════════════════════════════════════════════════════════════╝\033[0m"
        echo ""
    fi
}

case "${1:-check}" in
    update)
        if [[ -f "$NEW_IP_FILE" ]]; then
            cp "$NEW_IP_FILE" "$LAST_IP_FILE"
            rm -f "$ALERT_FILE" "$NEW_IP_FILE"
            echo "IP actualizada. Alerta removida."
        else
            # No hay nueva IP pendiente, guardar la actual
            current_ip=$(get_public_ip)
            if [[ -n "$current_ip" ]]; then
                echo "$current_ip" > "$LAST_IP_FILE"
                rm -f "$ALERT_FILE" "$NEW_IP_FILE"
                echo "IP guardada: $current_ip"
            else
                echo "Error: No se pudo obtener la IP pública"
                exit 1
            fi
        fi
        ;;

    show)
        get_public_ip
        echo
        ;;

    check|"")
        current_ip=$(get_public_ip)

        if [[ -z "$current_ip" ]]; then
            echo "Error: No se pudo obtener la IP pública"
            exit 1
        fi

        # Primera ejecución - guardar IP sin alertar
        if [[ ! -f "$LAST_IP_FILE" ]]; then
            echo "$current_ip" > "$LAST_IP_FILE"
            echo "Primera ejecución. IP guardada: $current_ip"
            exit 0
        fi

        last_ip=$(cat "$LAST_IP_FILE")

        if [[ "$current_ip" != "$last_ip" ]]; then
            echo "$current_ip" > "$NEW_IP_FILE"
            touch "$ALERT_FILE"
            echo "IP cambió: $last_ip -> $current_ip"
            show_alert
        else
            echo "IP sin cambios: $current_ip"
        fi
        ;;

    alert)
        # Llamado desde .bashrc para mostrar alerta si existe
        show_alert
        ;;

    *)
        echo "Uso: $0 [check|update|show|alert]"
        exit 1
        ;;
esac

---
# Configure SELinux for OrcaSlicer
# Note: GPU passthrough requires SecurityLabelDisable=true in Quadlet,
# so SELinux contexts for the container itself are not applicable.
# This file handles SELinux for the config directory.

- name: Check SELinux status
  ansible.builtin.command: getenforce
  register: selinux_status
  changed_when: false

- name: Display SELinux status
  ansible.builtin.debug:
    msg: "SELinux is {{ selinux_status.stdout }}"

- name: Install SELinux packages
  ansible.builtin.dnf:
    name: policycoreutils-python-utils
    state: present
  become: true
  when: selinux_status.stdout == "Enforcing"

- name: Set SELinux context for config directory
  community.general.sefcontext:
    target: "{{ orcaslicer_config_dir }}(/.*)?"
    setype: container_file_t
    state: present
  become: true
  when: selinux_status.stdout == "Enforcing"
  notify: apply selinux context

- name: Apply SELinux context immediately
  ansible.builtin.command: "restorecon -Rv {{ orcaslicer_config_dir }}"
  become: true
  when: selinux_status.stdout == "Enforcing"
  changed_when: false

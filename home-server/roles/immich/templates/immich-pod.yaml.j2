# Immich Pod - Kubernetes YAML for Podman Quadlet
# Generated by Ansible - DO NOT EDIT MANUALLY
apiVersion: v1
kind: Pod
metadata:
  name: {{ immich_pod_name }}
  labels:
    app: immich
spec:
  restartPolicy: Always

  containers:
  # Immich Server
  - name: immich-server
    image: {{ immich_server_image }}
    ports:
    - containerPort: 2283
      hostPort: {{ immich_port }}
      hostIP: {{ immich_host }}
    env:
    - name: UPLOAD_LOCATION
      value: "/data"
    - name: IMMICH_VERSION
      value: "{{ immich_version }}"
    - name: DB_HOSTNAME
      value: "127.0.0.1"
    - name: DB_USERNAME
      value: "{{ immich_db_username }}"
    - name: DB_PASSWORD
      value: "{{ immich_db_password }}"
    - name: DB_DATABASE_NAME
      value: "{{ immich_db_database }}"
    - name: REDIS_HOSTNAME
      value: "127.0.0.1"
    - name: TZ
      value: "{{ immich_timezone }}"
    volumeMounts:
    - name: upload-storage
      mountPath: /data
    - name: model-cache
      mountPath: /cache

  # Immich Machine Learning
  - name: immich-machine-learning
    image: {{ immich_ml_image }}
    env:
    - name: TZ
      value: "{{ immich_timezone }}"
    volumeMounts:
    - name: model-cache
      mountPath: /cache

  # Redis (Valkey)
  - name: redis
    image: {{ immich_redis_image }}

  # PostgreSQL Database
  - name: database
    image: {{ immich_postgres_image }}
    env:
    - name: POSTGRES_USER
      value: "{{ immich_db_username }}"
    - name: POSTGRES_PASSWORD
      value: "{{ immich_db_password }}"
    - name: POSTGRES_DB
      value: "{{ immich_db_database }}"
    - name: POSTGRES_INITDB_ARGS
      value: "--data-checksums"
    - name: TZ
      value: "{{ immich_timezone }}"
    volumeMounts:
    - name: database-storage
      mountPath: /var/lib/postgresql/data

  volumes:
  - name: upload-storage
    hostPath:
      path: {{ immich_upload_location }}
      type: Directory
  - name: database-storage
    hostPath:
      path: {{ immich_db_data_location }}
      type: Directory
  - name: model-cache
    hostPath:
      path: {{ immich_model_cache }}
      type: Directory
